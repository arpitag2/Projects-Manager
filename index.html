<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="APM">
<meta name="theme-color" content="#1a1714">
<title>Arpit's Project Manager</title>

<!-- PWA Manifest (inline) -->
<script>
const manifestData = {
  name: "Arpit's Project Manager",
  short_name: "APM",
  description: "Personal project & task manager",
  start_url: "./",
  display: "standalone",
  background_color: "#f5f2ee",
  theme_color: "#1a1714",
  orientation: "any",
  icons: [
    { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='38' fill='%231a1714'/%3E%3Ctext x='96' y='130' font-size='110' text-anchor='middle' fill='%23e8794a'%3Eâœ“%3C/text%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml" },
    { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%231a1714'/%3E%3Ctext x='256' y='350' font-size='300' text-anchor='middle' fill='%23e8794a'%3Eâœ“%3C/text%3E%3C/svg%3E", sizes: "512x512", type: "image/svg+xml" }
  ]
};
const blob = new Blob([JSON.stringify(manifestData)], {type:'application/json'});
const manifestUrl = URL.createObjectURL(blob);
const link = document.createElement('link');
link.rel = 'manifest'; link.href = manifestUrl;
document.head.appendChild(link);
</script>

<!-- Apple touch icon -->
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%231a1714'/%3E%3Ctext x='90' y='125' font-size='100' text-anchor='middle' fill='%23e8794a'%3Eâœ“%3C/text%3E%3C/svg%3E">

<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Epilogue:wght@300;400;500&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #f5f2ee;
  --surface: #ffffff;
  --surface2: #f0ece6;
  --surface3: #e8e3db;
  --ink: #1a1714;
  --ink2: #4a453f;
  --ink3: #8a837a;
  --accent: #d4522a;
  --accent2: #e8794a;
  --accent-bg: rgba(212,82,42,0.08);
  --green: #2a8a5a;
  --green-bg: rgba(42,138,90,0.1);
  --blue: #2a5fd4;
  --blue-bg: rgba(42,95,212,0.08);
  --yellow: #c9900a;
  --yellow-bg: rgba(201,144,10,0.1);
  --border: rgba(26,23,20,0.1);
  --border2: rgba(26,23,20,0.18);
  --shadow: 0 1px 3px rgba(26,23,20,0.08), 0 4px 16px rgba(26,23,20,0.06);
  --shadow-lg: 0 4px 24px rgba(26,23,20,0.12), 0 1px 4px rgba(26,23,20,0.08);
  --radius: 12px;
  --radius-sm: 7px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 15px; }
body {
  font-family: 'Epilogue', sans-serif;
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  min-height: -webkit-fill-available;
  background-image:
    radial-gradient(ellipse at 80% 0%, rgba(212,82,42,0.07) 0%, transparent 50%),
    radial-gradient(ellipse at 0% 100%, rgba(42,95,212,0.05) 0%, transparent 50%);
}

/* â”€â”€ SYNC STATUS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sync-bar {
  position: fixed; top: 0; left: 0; right: 0;
  height: 3px; z-index: 9999;
  background: transparent;
  transition: background 0.3s;
}
.sync-bar.syncing { background: linear-gradient(90deg, var(--accent), var(--accent2), var(--accent)); background-size: 200%; animation: syncPulse 1.2s linear infinite; }
.sync-bar.error { background: var(--accent); }
.sync-bar.ok { background: var(--green); animation: fadeOut 1s 0.5s forwards; }
@keyframes syncPulse { 0%{background-position:0%} 100%{background-position:200%} }
@keyframes fadeOut { to { opacity: 0; } }

.sync-indicator {
  position: fixed; top: 12px; right: 14px; z-index: 9998;
  display: flex; align-items: center; gap: 5px;
  font-size: 0.65rem; color: var(--ink3);
  opacity: 0; transition: opacity 0.3s;
  background: var(--surface); border: 1px solid var(--border);
  padding: 4px 9px; border-radius: 20px;
  box-shadow: var(--shadow);
}
.sync-indicator.show { opacity: 1; }
.sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }
.sync-dot.syncing { background: var(--yellow); animation: blink 0.8s infinite; }
.sync-dot.error { background: var(--accent); }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* â”€â”€ OFFLINE BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.offline-banner {
  position: fixed; bottom: calc(var(--safe-bottom) + 12px); left: 50%; transform: translateX(-50%);
  background: var(--ink); color: white; padding: 8px 16px; border-radius: 20px;
  font-size: 0.75rem; z-index: 9999; display: none; align-items: center; gap: 6px;
}
.offline-banner.show { display: flex; }

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app { display: flex; height: 100vh; height: -webkit-fill-available; overflow: hidden; }

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: 260px; flex-shrink: 0;
  background: var(--ink);
  display: flex; flex-direction: column;
  overflow: hidden;
  padding-top: var(--safe-top);
}
.sidebar-top { padding: 22px 20px 16px; border-bottom: 1px solid rgba(255,255,255,0.07); }
.app-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem; font-weight: 700; color: #fff;
  letter-spacing: 0.3px;
  display: flex; align-items: center; gap: 8px;
}
.app-logo-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent2); flex-shrink: 0; }
.app-tagline { font-size: 0.6rem; color: rgba(255,255,255,0.3); margin-top: 3px; letter-spacing: 1px; text-transform: uppercase; }
.sidebar-section-label { font-size: 0.58rem; text-transform: uppercase; letter-spacing: 2px; color: rgba(255,255,255,0.3); padding: 16px 20px 8px; }
.projects-list { flex: 1; overflow-y: auto; padding: 0 10px 10px; }
.projects-list::-webkit-scrollbar { width: 3px; }
.projects-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
.project-nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 10px; border-radius: 8px; cursor: pointer;
  transition: all 0.15s; margin-bottom: 2px;
}
.project-nav-item:hover { background: rgba(255,255,255,0.07); }
.project-nav-item.active { background: rgba(255,255,255,0.12); }
.project-nav-color { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.project-nav-name { font-size: 0.85rem; color: rgba(255,255,255,0.75); font-weight: 400; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.project-nav-item.active .project-nav-name { color: #fff; font-weight: 500; }
.project-nav-count { font-size: 0.65rem; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); padding: 1px 6px; border-radius: 10px; }
.project-nav-item.active .project-nav-count { background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.75); }
.btn-new-project {
  margin: 0 10px 16px; padding: 9px 12px;
  background: rgba(255,255,255,0.07); border: 1px dashed rgba(255,255,255,0.2);
  border-radius: 8px; color: rgba(255,255,255,0.5);
  font-family: 'Epilogue', sans-serif; font-size: 0.8rem; cursor: pointer;
  transition: all 0.2s; display: flex; align-items: center; gap: 8px;
  width: calc(100% - 20px);
}
.btn-new-project:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: rgba(255,255,255,0.75); }
.sidebar-stats { padding: 12px 20px; border-top: 1px solid rgba(255,255,255,0.07); padding-bottom: calc(16px + var(--safe-bottom)); }
.stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
.stat-label { font-size: 0.68rem; color: rgba(255,255,255,0.3); }
.stat-val { font-size: 0.68rem; color: rgba(255,255,255,0.6); font-weight: 500; }

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
.main::-webkit-scrollbar { width: 4px; }
.main::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }
.main-header {
  padding: 28px 32px 20px; padding-top: calc(28px + var(--safe-top));
  border-bottom: 1px solid var(--border);
  display: flex; align-items: flex-start; justify-content: space-between; gap: 16px;
  flex-shrink: 0; background: var(--bg);
  position: sticky; top: 0; z-index: 10;
}
.project-title-wrap { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
.project-color-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.project-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2rem; font-weight: 600; color: var(--ink);
  letter-spacing: 0.3px; line-height: 1.15;
  cursor: pointer; border-bottom: 2px solid transparent; transition: border-color 0.15s;
}
.project-title:hover { border-bottom-color: var(--accent); }
.project-meta { font-size: 0.72rem; color: var(--ink3); display: flex; align-items: center; gap: 12px; }
.meta-pill { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 12px; font-size: 0.65rem; font-weight: 500; }
.meta-pill.overdue { background: rgba(212,82,42,0.12); color: var(--accent); }
.meta-pill.due-soon { background: var(--yellow-bg); color: var(--yellow); }
.meta-pill.on-track { background: var(--green-bg); color: var(--green); }
.header-actions { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
.btn-header { padding: 8px 16px; border-radius: var(--radius-sm); font-family: 'Epilogue', sans-serif; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.15s; border: none; display: flex; align-items: center; gap: 6px; }
.btn-header.secondary { background: var(--surface2); color: var(--ink2); border: 1px solid var(--border); }
.btn-header.secondary:hover { background: var(--surface3); }
.btn-header.primary { background: var(--ink); color: #fff; }
.btn-header.primary:hover { background: var(--ink2); }
.btn-header.danger { background: rgba(212,82,42,0.1); color: var(--accent); border: 1px solid rgba(212,82,42,0.2); }
.btn-header.danger:hover { background: rgba(212,82,42,0.18); }

/* â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.progress-section { padding: 0 32px 20px; flex-shrink: 0; }
.progress-bar-wrap { background: var(--surface3); border-radius: 6px; height: 5px; overflow: hidden; margin-top: 10px; }
.progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 6px; transition: width 0.4s ease; }
.progress-label { display: flex; justify-content: space-between; font-size: 0.68rem; color: var(--ink3); margin-bottom: 5px; }

/* â”€â”€ TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tasks-wrap { padding: 0 32px 40px; flex: 1; }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; margin-top: 24px; }
.section-title { font-family: 'Cormorant Garamond', serif; font-size: 0.82rem; font-weight: 600; text-transform: uppercase; letter-spacing: 3px; color: var(--ink3); }
.section-count { font-size: 0.68rem; background: var(--surface3); color: var(--ink3); padding: 2px 8px; border-radius: 10px; }

/* â”€â”€ TASK CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.task-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 6px; transition: all 0.15s; box-shadow: var(--shadow); position: relative; }
.task-card:hover { box-shadow: var(--shadow-lg); border-color: var(--border2); }
.task-card.dragging { opacity: 0.5; transform: scale(0.98); }
.task-card.drag-over { border-color: var(--accent); border-style: dashed; }
.task-card.completed { opacity: 0.55; }
.task-main { display: flex; align-items: center; gap: 12px; padding: 13px 14px; }
.drag-handle { cursor: grab; color: var(--ink3); font-size: 0.75rem; flex-shrink: 0; opacity: 0; transition: opacity 0.15s; padding: 2px 4px; }
.task-card:hover .drag-handle { opacity: 1; }
.drag-handle:active { cursor: grabbing; }
.task-checkbox { width: 18px; height: 18px; border-radius: 5px; border: 2px solid var(--border2); flex-shrink: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; background: transparent; }
.task-checkbox:hover { border-color: var(--accent); background: var(--accent-bg); }
.task-checkbox.checked { background: var(--green); border-color: var(--green); color: white; font-size: 0.7rem; }
.task-content { flex: 1; min-width: 0; }
.task-name { font-size: 0.9rem; font-weight: 400; color: var(--ink); line-height: 1.4; cursor: pointer; }
.task-name:hover { color: var(--accent); }
.task-card.completed .task-name { text-decoration: line-through; color: var(--ink3); }
.task-badges { display: flex; gap: 5px; margin-top: 4px; flex-wrap: wrap; align-items: center; }
.badge { font-size: 0.62rem; padding: 2px 7px; border-radius: 10px; font-weight: 500; display: inline-flex; align-items: center; gap: 3px; }
.badge.overdue { background: rgba(212,82,42,0.12); color: var(--accent); }
.badge.due-soon { background: var(--yellow-bg); color: var(--yellow); }
.badge.due-ok { background: var(--blue-bg); color: var(--blue); }
.badge.done { background: var(--green-bg); color: var(--green); }
.badge.subtask-count { background: var(--surface2); color: var(--ink3); border: 1px solid var(--border); }
.task-actions { display: flex; gap: 4px; flex-shrink: 0; opacity: 0; transition: opacity 0.15s; }
.task-card:hover .task-actions { opacity: 1; }
.task-action-btn { background: transparent; border: none; color: var(--ink3); font-size: 0.8rem; cursor: pointer; padding: 4px 6px; border-radius: 5px; transition: all 0.15s; }
.task-action-btn:hover { background: var(--surface2); color: var(--ink); }
.task-action-btn.red:hover { background: rgba(212,82,42,0.1); color: var(--accent); }

/* â”€â”€ SUBTASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.subtasks-wrap { padding: 0 14px 10px 44px; display: none; }
.subtasks-wrap.open { display: block; }
.subtask-row { display: flex; align-items: center; gap: 8px; padding: 5px 8px; border-radius: 6px; transition: background 0.12s; margin-bottom: 2px; }
.subtask-row:hover { background: var(--surface2); }
.subtask-checkbox { width: 14px; height: 14px; border-radius: 3px; border: 1.5px solid var(--border2); flex-shrink: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; transition: all 0.15s; background: transparent; }
.subtask-checkbox:hover { border-color: var(--green); }
.subtask-checkbox.checked { background: var(--green); border-color: var(--green); color: white; }
.subtask-name { font-size: 0.8rem; color: var(--ink2); flex: 1; cursor: pointer; }
.subtask-name:hover { color: var(--accent); }
.subtask-row.completed .subtask-name { text-decoration: line-through; color: var(--ink3); }
.subtask-del { background: transparent; border: none; color: var(--ink3); font-size: 0.75rem; cursor: pointer; padding: 2px 5px; border-radius: 4px; opacity: 0; transition: all 0.12s; }
.subtask-row:hover .subtask-del { opacity: 1; }
.subtask-del:hover { color: var(--accent); }
.add-subtask-row { display: flex; align-items: center; gap: 8px; padding: 4px 8px; }
.add-subtask-input { flex: 1; background: transparent; border: none; border-bottom: 1px dashed var(--border2); color: var(--ink); font-family: 'Epilogue', sans-serif; font-size: 0.8rem; padding: 3px 0; outline: none; }
.add-subtask-input::placeholder { color: var(--ink3); }
.add-subtask-btn { background: transparent; border: none; color: var(--accent); font-size: 0.75rem; cursor: pointer; font-weight: 600; font-family: 'Epilogue', sans-serif; }

/* â”€â”€ ADD TASK ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.add-task-row { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--surface2); border: 1.5px dashed var(--border2); border-radius: var(--radius); margin-top: 8px; transition: all 0.15s; }
.add-task-row:focus-within { background: var(--surface); border-color: var(--accent); border-style: solid; }
.add-task-input { flex: 1; background: transparent; border: none; color: var(--ink); font-family: 'Epilogue', sans-serif; font-size: 0.9rem; outline: none; }
.add-task-input::placeholder { color: var(--ink3); }
.add-task-date { background: transparent; border: 1px solid var(--border); border-radius: 5px; padding: 4px 8px; color: var(--ink2); font-family: 'Epilogue', sans-serif; font-size: 0.75rem; cursor: pointer; outline: none; }
.add-task-date:focus { border-color: var(--accent); }
.btn-add-task { background: var(--ink); color: white; border: none; border-radius: 6px; padding: 6px 14px; font-family: 'Epilogue', sans-serif; font-size: 0.78rem; font-weight: 500; cursor: pointer; transition: background 0.15s; white-space: nowrap; }
.btn-add-task:hover { background: var(--accent); }

/* â”€â”€ EMPTY / WELCOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state { text-align: center; padding: 60px 20px; color: var(--ink3); }
.empty-icon { font-size: 2.5rem; margin-bottom: 12px; }
.empty-title { font-family: 'Cormorant Garamond', serif; font-size: 1.2rem; font-weight: 600; color: var(--ink2); margin-bottom: 6px; }
.empty-sub { font-size: 0.82rem; }
.welcome-state { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; padding: 40px; text-align: center; }
.welcome-title { font-family: 'Cormorant Garamond', serif; font-size: 2.4rem; font-weight: 600; color: var(--ink); margin-bottom: 8px; letter-spacing: 0.3px; }
.welcome-sub { font-size: 0.88rem; color: var(--ink3); margin-bottom: 28px; }
.btn-welcome { padding: 12px 28px; background: var(--ink); color: white; border: none; border-radius: 10px; font-family: 'Epilogue', sans-serif; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.15s; }
.btn-welcome:hover { background: var(--accent); }

/* â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay { position: fixed; inset: 0; background: rgba(26,23,20,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal { background: var(--surface); border-radius: 16px; padding: 24px; width: 100%; max-width: 460px; box-shadow: var(--shadow-lg); transform: translateY(12px); transition: transform 0.25s; }
.modal-overlay.open .modal { transform: translateY(0); }
.modal-title { font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; font-weight: 600; margin-bottom: 18px; color: var(--ink); }
.form-group { margin-bottom: 14px; }
.form-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 2px; color: var(--ink3); margin-bottom: 5px; display: block; }
.form-input { width: 100%; background: var(--surface2); border: 1.5px solid var(--border); border-radius: var(--radius-sm); padding: 9px 12px; color: var(--ink); font-family: 'Epilogue', sans-serif; font-size: 0.9rem; outline: none; transition: border-color 0.15s; }
.form-input:focus { border-color: var(--accent); }
.form-input::placeholder { color: var(--ink3); }
.form-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
.color-picker-row { display: flex; gap: 8px; flex-wrap: wrap; }
.color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.15s; }
.color-swatch.selected { border-color: var(--ink); transform: scale(1.15); }
.modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }
.btn-modal { padding: 9px 20px; border-radius: var(--radius-sm); font-family: 'Epilogue', sans-serif; font-size: 0.85rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; }
.btn-modal.cancel { background: var(--surface2); color: var(--ink2); border: 1px solid var(--border); }
.btn-modal.cancel:hover { background: var(--surface3); }
.btn-modal.confirm { background: var(--ink); color: white; }
.btn-modal.confirm:hover { background: var(--accent); }

/* â”€â”€ LOADING SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading-screen {
  position: fixed; inset: 0; background: var(--ink);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 9999; transition: opacity 0.4s;
}
.loading-screen.hide { opacity: 0; pointer-events: none; }
.loading-logo { font-family: 'Cormorant Garamond', serif; font-size: 2rem; font-weight: 600; color: white; letter-spacing: 0.5px; margin-bottom: 8px; }
.loading-sub { font-size: 0.72rem; color: rgba(255,255,255,0.35); letter-spacing: 2px; text-transform: uppercase; }
.loading-dot-row { display: flex; gap: 6px; margin-top: 28px; }
.loading-dot { width: 7px; height: 7px; border-radius: 50%; background: rgba(255,255,255,0.2); animation: dotPulse 1.4s infinite; }
.loading-dot:nth-child(2) { animation-delay: 0.2s; }
.loading-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes dotPulse { 0%,80%,100%{background:rgba(255,255,255,0.2)} 40%{background:var(--accent2)} }

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast { position: fixed; bottom: calc(var(--safe-bottom) + 24px); left: 50%; transform: translateX(-50%) translateY(10px); background: var(--ink); color: #fff; padding: 9px 18px; border-radius: 8px; font-size: 0.82rem; opacity: 0; pointer-events: none; transition: all 0.25s; z-index: 9999; white-space: nowrap; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â”€â”€ MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 640px) {
  .sidebar { width: 220px; }
  .main-header { padding: 18px 18px 14px; padding-top: calc(18px + var(--safe-top)); }
  .tasks-wrap { padding: 0 18px 40px; }
  .progress-section { padding: 0 18px 16px; }
}
@media (max-width: 480px) {
  .sidebar { position: fixed; left: -240px; top: 0; bottom: 0; z-index: 100; transition: left 0.25s; width: 240px; box-shadow: none; }
  .sidebar.mobile-open { left: 0; box-shadow: 4px 0 24px rgba(0,0,0,0.3); }
  .main { width: 100vw; }
  .mobile-toggle { display: flex !important; }
  .task-actions { opacity: 1 !important; }
  .drag-handle { opacity: 1 !important; }
}
.mobile-toggle { display: none; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 6px 10px; cursor: pointer; font-size: 0.85rem; align-items: center; gap: 6px; color: var(--ink2); }

@keyframes slideIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform: translateY(0); } }
.task-card { animation: slideIn 0.2s ease; }
</style>
</head>
<body>

<!-- Loading screen -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">Arpit's Project Manager</div>
  <div class="loading-sub">Loading your projectsâ€¦</div>
  <div class="loading-dot-row">
    <div class="loading-dot"></div>
    <div class="loading-dot"></div>
    <div class="loading-dot"></div>
  </div>
</div>

<div class="sync-bar" id="syncBar"></div>
<div class="sync-indicator" id="syncIndicator">
  <div class="sync-dot" id="syncDot"></div>
  <span id="syncText">Saved</span>
</div>
<div class="offline-banner" id="offlineBanner">âš¡ Offline â€” changes will sync when reconnected</div>

<div class="app">
  <div class="sidebar" id="sidebar">
    <div class="sidebar-top">
      <div class="app-logo"><div class="app-logo-dot"></div>Arpit's PM</div>
      <div class="app-tagline">Project Manager</div>
    </div>
    <div class="sidebar-section-label">Projects</div>
    <div class="projects-list" id="projectsList"></div>
    <button class="btn-new-project" onclick="openNewProjectModal()"><span>+</span> New Project</button>
    <div class="sidebar-stats">
      <div class="stat-row"><span class="stat-label">Total tasks</span><span class="stat-val" id="statTotal">0</span></div>
      <div class="stat-row"><span class="stat-label">Completed</span><span class="stat-val" id="statDone">0</span></div>
      <div class="stat-row"><span class="stat-label">Overdue</span><span class="stat-val" id="statOverdue" style="color:#e8794a">0</span></div>
    </div>
  </div>
  <div class="main" id="main">
    <div id="mainContent"></div>
  </div>
</div>

<!-- New/Edit Project Modal -->
<div class="modal-overlay" id="projectModal" onclick="handleModalClick(event,'projectModal')">
  <div class="modal">
    <div class="modal-title" id="projectModalTitle">New Project</div>
    <div class="form-group">
      <label class="form-label">Project Name</label>
      <input class="form-input" id="projectName" placeholder="e.g. Research Paper, Course Prepâ€¦" />
    </div>
    <div class="form-group">
      <label class="form-label">Colour</label>
      <div class="color-picker-row" id="colorPicker"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-modal cancel" onclick="closeModal('projectModal')">Cancel</button>
      <button class="btn-modal confirm" onclick="saveProject()">Save Project</button>
    </div>
  </div>
</div>

<!-- Edit Task Modal -->
<div class="modal-overlay" id="taskModal" onclick="handleModalClick(event,'taskModal')">
  <div class="modal">
    <div class="modal-title">Edit Task</div>
    <div class="form-group">
      <label class="form-label">Task Name</label>
      <input class="form-input" id="editTaskName" placeholder="Task nameâ€¦" />
    </div>
    <div class="form-row-2">
      <div>
        <label class="form-label">Due Date</label>
        <input class="form-input" id="editTaskDate" type="date" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-modal cancel" onclick="closeModal('taskModal')">Cancel</button>
      <button class="btn-modal confirm" onclick="saveTaskEdit()">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸  CONFIGURATION â€” PASTE YOUR SUPABASE DETAILS HERE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL  = 'https://isegkbmwdytgsywldodj.supabase.co';
// e.g.  'https://isegkbmwdytgsywldodj.supabase.co'

const SUPABASE_KEY  = 'sb_publishable_g_zFoxmxktNvylz4tX2WNA_h-tKaWE8';
// e.g.  'eyJhbGciOiJIUzI1NiIsInR5cCI6...'

// Device ID â€” this ties your data to your devices. Change this if you want
// to share data between devices, or keep it unique per device.
// Leave it as-is; it auto-generates a persistent ID for this browser.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DEVICE_ID = (() => {
  let id = localStorage.getItem('apm_device_id');
  if (!id) { id = 'arpit_' + Math.random().toString(36).slice(2,10); localStorage.setItem('apm_device_id', id); }
  return id;
})();

const HEADERS = {
  'Content-Type': 'application/json',
  'apikey': SUPABASE_KEY,
  'Authorization': `Bearer ${SUPABASE_KEY}`,
  'Prefer': 'return=representation'
};

const isConfigured = SUPABASE_URL !== 'PASTE_YOUR_SUPABASE_URL_HERE' && SUPABASE_KEY !== 'PASTE_YOUR_SUPABASE_ANON_KEY_HERE';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCAL STATE + OFFLINE QUEUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROJECT_COLORS = ['#d4522a','#e8b84b','#2a8a5a','#2a5fd4','#9b59b6','#e84393','#16a085','#c0392b','#2c3e50','#8a7a5a'];
let data = { projects: [], nextId: 1 };
let activeProjectId = null;
let editingProjectId = null;
let editingTaskId = null;
let dragSrcId = null;
let isOnline = navigator.onLine;
let pendingSync = false;
let syncTimeout = null;

// â”€â”€ LOCAL STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveLocal() {
  try { localStorage.setItem('apm_data', JSON.stringify(data)); } catch(e) {}
}
function loadLocal() {
  try { const r = localStorage.getItem('apm_data'); if (r) data = JSON.parse(r); } catch(e) {}
}

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function uid() { return data.nextId++; }
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function daysDiff(dateStr) {
  if (!dateStr) return null;
  const now = new Date(); now.setHours(0,0,0,0);
  const d = new Date(dateStr); d.setHours(0,0,0,0);
  return Math.round((d - now) / 86400000);
}
function dueBadge(dateStr, completed) {
  if (!dateStr) return '';
  if (completed) return `<span class="badge done">âœ“ Done</span>`;
  const diff = daysDiff(dateStr);
  const fmt = new Date(dateStr).toLocaleDateString('en-IN', {day:'numeric',month:'short'});
  if (diff < 0) return `<span class="badge overdue">âš  ${Math.abs(diff)}d overdue</span>`;
  if (diff === 0) return `<span class="badge due-soon">Due today</span>`;
  if (diff <= 3) return `<span class="badge due-soon">Due ${fmt}</span>`;
  return `<span class="badge due-ok">ğŸ“… ${fmt}</span>`;
}
function showToast(msg, dur=2200) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(t._t); t._t = setTimeout(() => t.classList.remove('show'), dur);
}
function getProject(id) { return data.projects.find(p => p.id === id); }
function getTask(project, id) { return project?.tasks.find(t => t.id === id); }

// â”€â”€ SYNC STATUS UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSyncStatus(status) {
  const bar = document.getElementById('syncBar');
  const dot = document.getElementById('syncDot');
  const txt = document.getElementById('syncText');
  const ind = document.getElementById('syncIndicator');
  bar.className = 'sync-bar ' + status;
  dot.className = 'sync-dot ' + status;
  ind.classList.add('show');
  if (status === 'syncing') { txt.textContent = 'Syncingâ€¦'; }
  else if (status === 'ok') { txt.textContent = 'Saved'; clearTimeout(ind._t); ind._t = setTimeout(() => ind.classList.remove('show'), 2000); }
  else if (status === 'error') { txt.textContent = 'Sync failed'; }
  else if (status === 'offline') { txt.textContent = 'Offline'; }
}

// â”€â”€ SUPABASE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dbUpsert(payload) {
  if (!isConfigured) return;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/apm_data?device_id=eq.${DEVICE_ID}`, {
    method: 'POST',
    headers: { ...HEADERS, 'Prefer': 'resolution=merge-duplicates,return=representation' },
    body: JSON.stringify({ device_id: DEVICE_ID, payload: JSON.stringify(payload), updated_at: new Date().toISOString() })
  });
  if (!res.ok) throw new Error(await res.text());
}

async function dbFetch() {
  if (!isConfigured) return null;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/apm_data?device_id=eq.${DEVICE_ID}&select=payload`, {
    headers: HEADERS
  });
  if (!res.ok) throw new Error(await res.text());
  const rows = await res.json();
  return rows.length > 0 ? JSON.parse(rows[0].payload) : null;
}

async function ensureTable() {
  if (!isConfigured) return;
  // Try to create the table via RPC â€” won't error if it exists
  await fetch(`${SUPABASE_URL}/rest/v1/rpc/create_apm_table_if_not_exists`, {
    method: 'POST', headers: HEADERS, body: '{}'
  }).catch(() => {}); // silently fail â€” table may already exist
}

// â”€â”€ SYNC ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scheduleSave() {
  saveLocal();
  if (!isConfigured || !isOnline) { pendingSync = true; return; }
  clearTimeout(syncTimeout);
  syncTimeout = setTimeout(pushToCloud, 800);
}

async function pushToCloud() {
  if (!isConfigured || !isOnline) return;
  setSyncStatus('syncing');
  try {
    await dbUpsert(data);
    setSyncStatus('ok');
    pendingSync = false;
  } catch(e) {
    setSyncStatus('error');
    pendingSync = true;
    console.warn('Sync failed:', e.message);
  }
}

async function pullFromCloud() {
  if (!isConfigured || !isOnline) return false;
  try {
    const remote = await dbFetch();
    if (!remote) return false;
    // Merge: use remote if it's newer (more projects/tasks) â€” simple strategy
    if (remote.projects && remote.nextId >= data.nextId) {
      data = remote;
      saveLocal();
      return true;
    }
    return false;
  } catch(e) {
    console.warn('Pull failed:', e.message);
    return false;
  }
}

// â”€â”€ ONLINE / OFFLINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('online', async () => {
  isOnline = true;
  document.getElementById('offlineBanner').classList.remove('show');
  if (pendingSync) {
    showToast('Back online â€” syncingâ€¦');
    await pushToCloud();
  }
});
window.addEventListener('offline', () => {
  isOnline = false;
  document.getElementById('offlineBanner').classList.add('show');
  setSyncStatus('offline');
});

// â”€â”€ CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createProject(name, color) {
  const p = { id: uid(), name, color, tasks: [], createdAt: Date.now() };
  data.projects.push(p); scheduleSave(); return p;
}
function deleteProject(id) {
  if (!confirm('Delete this project and all its tasks?')) return;
  data.projects = data.projects.filter(p => p.id !== id);
  if (activeProjectId === id) activeProjectId = data.projects[0]?.id || null;
  scheduleSave(); renderAll();
}
function addTask(projectId, name, dueDate) {
  const p = getProject(projectId); if (!p) return;
  p.tasks.push({ id: uid(), name, dueDate: dueDate||'', completed: false, subtasks: [], expanded: false });
  scheduleSave(); renderMain();
}
function toggleTask(projectId, taskId) {
  const t = getTask(getProject(projectId), taskId); if (!t) return;
  t.completed = !t.completed; scheduleSave(); renderMain();
}
function deleteTask(projectId, taskId) {
  const p = getProject(projectId); if (!p) return;
  p.tasks = p.tasks.filter(t => t.id !== taskId); scheduleSave(); renderMain();
}
function toggleExpand(projectId, taskId) {
  const t = getTask(getProject(projectId), taskId); if (!t) return;
  t.expanded = !t.expanded; scheduleSave(); renderMain();
}
function addSubtask(projectId, taskId, name) {
  const t = getTask(getProject(projectId), taskId); if (!t || !name.trim()) return;
  t.subtasks.push({ id: uid(), name: name.trim(), completed: false });
  t.expanded = true; scheduleSave(); renderMain();
}
function toggleSubtask(projectId, taskId, subId) {
  const t = getTask(getProject(projectId), taskId); if (!t) return;
  const s = t.subtasks.find(s => s.id === subId); if (s) s.completed = !s.completed;
  scheduleSave(); renderMain();
}
function deleteSubtask(projectId, taskId, subId) {
  const t = getTask(getProject(projectId), taskId); if (!t) return;
  t.subtasks = t.subtasks.filter(s => s.id !== subId); scheduleSave(); renderMain();
}

// â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedColor = PROJECT_COLORS[0];
function openNewProjectModal() {
  editingProjectId = null; selectedColor = PROJECT_COLORS[0];
  document.getElementById('projectModalTitle').textContent = 'New Project';
  document.getElementById('projectName').value = '';
  renderColorPicker(); openModal('projectModal');
  setTimeout(() => document.getElementById('projectName').focus(), 100);
}
function openEditProjectModal(id) {
  const p = getProject(id); if (!p) return;
  editingProjectId = id; selectedColor = p.color;
  document.getElementById('projectModalTitle').textContent = 'Edit Project';
  document.getElementById('projectName').value = p.name;
  renderColorPicker(); openModal('projectModal');
}
function renderColorPicker() {
  document.getElementById('colorPicker').innerHTML = PROJECT_COLORS.map(c =>
    `<div class="color-swatch${c===selectedColor?' selected':''}" style="background:${c}" onclick="selectColor('${c}')"></div>`
  ).join('');
}
function selectColor(c) { selectedColor = c; renderColorPicker(); }
function saveProject() {
  const name = document.getElementById('projectName').value.trim();
  if (!name) { showToast('Enter a project name'); return; }
  if (editingProjectId) { const p = getProject(editingProjectId); p.name = name; p.color = selectedColor; }
  else { activeProjectId = createProject(name, selectedColor).id; }
  scheduleSave(); closeModal('projectModal'); renderAll();
}
function openEditTaskModal(projectId, taskId) {
  const t = getTask(getProject(projectId), taskId); if (!t) return;
  editingTaskId = { projectId, taskId };
  document.getElementById('editTaskName').value = t.name;
  document.getElementById('editTaskDate').value = t.dueDate || '';
  openModal('taskModal');
  setTimeout(() => document.getElementById('editTaskName').focus(), 100);
}
function saveTaskEdit() {
  if (!editingTaskId) return;
  const { projectId, taskId } = editingTaskId;
  const t = getTask(getProject(projectId), taskId); if (!t) return;
  const name = document.getElementById('editTaskName').value.trim();
  if (!name) { showToast('Enter a task name'); return; }
  t.name = name; t.dueDate = document.getElementById('editTaskDate').value;
  scheduleSave(); closeModal('taskModal'); renderMain();
}
function openModal(id) { document.getElementById(id).classList.add('open'); document.body.style.overflow='hidden'; }
function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow=''; }
function handleModalClick(e, id) { if (e.target === document.getElementById(id)) closeModal(id); }

// â”€â”€ DRAG AND DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDragStart(e, taskId) { dragSrcId = taskId; e.dataTransfer.effectAllowed = 'move'; e.currentTarget.classList.add('dragging'); }
function onDragEnd(e) { e.currentTarget.classList.remove('dragging'); document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over')); }
function onDragOver(e, taskId) { e.preventDefault(); if (taskId === dragSrcId) return; document.querySelectorAll('.task-card').forEach(c => c.classList.remove('drag-over')); e.currentTarget.classList.add('drag-over'); }
function onDrop(e, taskId) {
  e.preventDefault(); if (taskId === dragSrcId) return;
  const p = getProject(activeProjectId); if (!p) return;
  const si = p.tasks.findIndex(t => t.id === dragSrcId);
  const di = p.tasks.findIndex(t => t.id === taskId);
  if (si < 0 || di < 0) return;
  const [moved] = p.tasks.splice(si, 1); p.tasks.splice(di, 0, moved);
  scheduleSave(); renderMain();
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSidebar() {
  let total=0,done=0,overdue=0;
  data.projects.forEach(p => p.tasks.forEach(t => {
    total++; if(t.completed) done++;
    else if(t.dueDate && daysDiff(t.dueDate)<0) overdue++;
  }));
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statDone').textContent = done;
  document.getElementById('statOverdue').textContent = overdue;
  document.getElementById('projectsList').innerHTML = data.projects.map(p => {
    const pending = p.tasks.filter(t => !t.completed).length;
    return `<div class="project-nav-item${p.id===activeProjectId?' active':''}" onclick="selectProject(${p.id})">
      <div class="project-nav-color" style="background:${p.color}"></div>
      <span class="project-nav-name">${escHtml(p.name)}</span>
      ${pending>0?`<span class="project-nav-count">${pending}</span>`:''}
    </div>`;
  }).join('');
}

function renderMain() {
  const el = document.getElementById('mainContent');
  if (data.projects.length === 0) {
    el.innerHTML = `<div class="welcome-state">
      <div style="font-size:3rem;margin-bottom:16px">ğŸ“‹</div>
      <div class="welcome-title">Welcome, Arpit</div>
      <div class="welcome-sub">Organise your work into projects with tasks, deadlines, and subtasks.${isConfigured?'<br><span style="color:var(--green);font-size:0.8rem">âœ“ Syncing across all your devices</span>':''}</div>
      <button class="btn-welcome" onclick="openNewProjectModal()">+ Create your first project</button>
    </div>`;
    return;
  }
  const p = getProject(activeProjectId);
  if (!p) { el.innerHTML=''; return; }
  const pending = p.tasks.filter(t=>!t.completed);
  const completed = p.tasks.filter(t=>t.completed);
  const total = p.tasks.length;
  const doneCount = completed.length;
  const pct = total>0?Math.round((doneCount/total)*100):0;
  const overdueCount = pending.filter(t=>t.dueDate&&daysDiff(t.dueDate)<0).length;
  const dueSoon = pending.filter(t=>t.dueDate&&daysDiff(t.dueDate)>=0&&daysDiff(t.dueDate)<=3).length;
  let statusPill = '';
  if(overdueCount>0) statusPill=`<span class="meta-pill overdue">âš  ${overdueCount} overdue</span>`;
  else if(dueSoon>0) statusPill=`<span class="meta-pill due-soon">${dueSoon} due soon</span>`;
  else if(total>0) statusPill=`<span class="meta-pill on-track">On track</span>`;

  el.innerHTML = `
    <div class="main-header">
      <div class="main-header-left">
        <div class="project-title-wrap">
          <div class="project-color-dot" style="background:${p.color}"></div>
          <div class="project-title">${escHtml(p.name)}</div>
        </div>
        <div class="project-meta">
          <span>${total} task${total!==1?'s':''} Â· ${doneCount} done</span>
          ${statusPill}
        </div>
      </div>
      <div class="header-actions">
        <button class="btn-header secondary mobile-toggle" onclick="toggleSidebar()">â˜° Projects</button>
        <button class="btn-header secondary" onclick="openEditProjectModal(${p.id})">âœ Edit</button>
        <button class="btn-header danger" onclick="deleteProject(${p.id})">ğŸ—‘</button>
      </div>
    </div>
    <div class="progress-section">
      <div class="progress-label"><span>Progress</span><span>${pct}% complete</span></div>
      <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
    </div>
    <div class="tasks-wrap">
      ${pending.length>0?`
        <div class="section-header">
          <span class="section-title">To Do</span>
          <span class="section-count">${pending.length}</span>
        </div>
        ${pending.map(t=>renderTaskCard(p,t)).join('')}
      `:''}
      <div class="add-task-row">
        <span style="color:var(--ink3);font-size:0.85rem">+</span>
        <input class="add-task-input" id="newTaskInput" placeholder="Add a taskâ€¦ press Enter" onkeydown="handleAddTask(event,${p.id})"/>
        <input class="add-task-date" id="newTaskDate" type="date" title="Due date (optional)"/>
        <button class="btn-add-task" onclick="doAddTask(${p.id})">Add</button>
      </div>
      ${completed.length>0?`
        <div class="section-header" style="margin-top:28px">
          <span class="section-title">Completed</span>
          <span class="section-count">${completed.length}</span>
        </div>
        ${completed.map(t=>renderTaskCard(p,t)).join('')}
      `:''}
      ${total===0?`<div class="empty-state"><div class="empty-icon">âœ¨</div><div class="empty-title">No tasks yet</div><div class="empty-sub">Use the box above to add your first task</div></div>`:''}
    </div>
  `;

  document.querySelectorAll('.task-card[draggable]').forEach(card => {
    const id = parseInt(card.dataset.id);
    card.addEventListener('dragstart', e=>onDragStart(e,id));
    card.addEventListener('dragend', e=>onDragEnd(e));
    card.addEventListener('dragover', e=>onDragOver(e,id));
    card.addEventListener('drop', e=>onDrop(e,id));
  });
  renderSidebar();
}

function renderTaskCard(p, t) {
  const subDone = t.subtasks.filter(s=>s.completed).length;
  const subTotal = t.subtasks.length;
  const subBadge = subTotal>0?`<span class="badge subtask-count">${subDone}/${subTotal} subtasks</span>`:'';
  return `
    <div class="task-card${t.completed?' completed':''}" draggable="true" data-id="${t.id}">
      <div class="task-main">
        <span class="drag-handle">â ¿</span>
        <div class="task-checkbox${t.completed?' checked':''}" onclick="toggleTask(${p.id},${t.id})">${t.completed?'âœ“':''}</div>
        <div class="task-content">
          <div class="task-name" ondblclick="openEditTaskModal(${p.id},${t.id})">${escHtml(t.name)}</div>
          <div class="task-badges">${dueBadge(t.dueDate,t.completed)}${subBadge}</div>
        </div>
        <div class="task-actions">
          <button class="task-action-btn" onclick="toggleExpand(${p.id},${t.id})" title="${t.expanded?'Collapse':'Expand'}">${t.expanded?'â–²':'â–¼'}</button>
          <button class="task-action-btn" onclick="openEditTaskModal(${p.id},${t.id})" title="Edit">âœ</button>
          <button class="task-action-btn red" onclick="deleteTask(${p.id},${t.id})" title="Delete">ğŸ—‘</button>
        </div>
      </div>
      <div class="subtasks-wrap${t.expanded?' open':''}" id="sub-${t.id}">
        ${t.subtasks.map(s=>`
          <div class="subtask-row${s.completed?' completed':''}">
            <div class="subtask-checkbox${s.completed?' checked':''}" onclick="toggleSubtask(${p.id},${t.id},${s.id})">${s.completed?'âœ“':''}</div>
            <span class="subtask-name">${escHtml(s.name)}</span>
            <button class="subtask-del" onclick="deleteSubtask(${p.id},${t.id},${s.id})">âœ•</button>
          </div>
        `).join('')}
        <div class="add-subtask-row">
          <span style="font-size:0.75rem;color:var(--ink3)">â†³</span>
          <input class="add-subtask-input" placeholder="Add subtaskâ€¦" id="sub-input-${t.id}" onkeydown="handleAddSubtask(event,${p.id},${t.id})"/>
          <button class="add-subtask-btn" onclick="doAddSubtask(${p.id},${t.id})">+ Add</button>
        </div>
      </div>
    </div>`;
}

function renderAll() { renderSidebar(); renderMain(); }

// â”€â”€ INTERACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectProject(id) {
  activeProjectId = id; renderAll();
  document.getElementById('sidebar').classList.remove('mobile-open');
}
function handleAddTask(e, pid) { if(e.key==='Enter') doAddTask(pid); }
function doAddTask(pid) {
  const inp = document.getElementById('newTaskInput');
  const dt = document.getElementById('newTaskDate');
  const name = inp?.value.trim(); if(!name){inp?.focus();return;}
  addTask(pid, name, dt?.value||'');
  setTimeout(()=>document.getElementById('newTaskInput')?.focus(),50);
}
function handleAddSubtask(e,pid,tid){if(e.key==='Enter')doAddSubtask(pid,tid);}
function doAddSubtask(pid,tid){
  const inp=document.getElementById(`sub-input-${tid}`);if(!inp)return;
  addSubtask(pid,tid,inp.value);
  setTimeout(()=>document.getElementById(`sub-input-${tid}`)?.focus(),50);
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('mobile-open');}

document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeModal('projectModal');closeModal('taskModal');}
});
document.getElementById('projectName').addEventListener('keydown',e=>{if(e.key==='Enter')saveProject();});
document.getElementById('editTaskName').addEventListener('keydown',e=>{if(e.key==='Enter')saveTaskEdit();});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  loadLocal();

  // Try pulling latest from cloud
  const pulled = await pullFromCloud();

  // Seed demo data if brand new
  if (data.projects.length === 0) {
    const p = createProject('PhD Research', PROJECT_COLORS[2]);
    p.tasks.push(
      { id: uid(), name: 'Literature review', dueDate: new Date(Date.now()+3*86400000).toISOString().split('T')[0], completed: false, subtasks: [{id:uid(),name:'Find 20 papers',completed:true},{id:uid(),name:'Summarise key findings',completed:false}], expanded: true },
      { id: uid(), name: 'Draft methodology chapter', dueDate: new Date(Date.now()+14*86400000).toISOString().split('T')[0], completed: false, subtasks: [], expanded: false },
      { id: uid(), name: 'Meet with advisor', dueDate: '', completed: true, subtasks: [], expanded: false }
    );
    const p2 = createProject('Teaching â€” MGMT 6580', PROJECT_COLORS[0]);
    p2.tasks.push(
      { id: uid(), name: 'Prepare case study slides', dueDate: new Date(Date.now()+2*86400000).toISOString().split('T')[0], completed: false, subtasks: [], expanded: false },
      { id: uid(), name: 'Grade midterm papers', dueDate: new Date(Date.now()-1*86400000).toISOString().split('T')[0], completed: false, subtasks: [], expanded: false }
    );
    activeProjectId = p.id;
    scheduleSave();
  } else {
    activeProjectId = data.projects[0]?.id;
    if (pulled) showToast('âœ“ Synced from cloud');
  }

  if (!isConfigured) {
    setTimeout(() => showToast('âš™ Add Supabase keys to enable sync', 4000), 1500);
  }

  renderAll();

  // Hide loading screen
  setTimeout(() => {
    document.getElementById('loadingScreen').classList.add('hide');
    setTimeout(() => document.getElementById('loadingScreen').remove(), 500);
  }, 600);
}

init();
</script>
</body>
</html>
